name: Publish NuGet Packages

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: Release

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for GitVersion or similar tools
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0.11.0
      with:
        versionSpec: '5.x'
        
    - name: Determine Version
      uses: gittools/actions/gitversion/execute@v0.11.0
      id: gitversion
      with:
        useConfigFile: true
        
    - name: Display GitVersion outputs
      run: |
        echo "NuGetVersion: ${{ steps.gitversion.outputs.nuGetVersion }}"
        echo "SemVer: ${{ steps.gitversion.outputs.semVer }}"
        echo "FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"
        echo "InformationalVersion: ${{ steps.gitversion.outputs.informationalVersion }}"
        echo "BranchName: ${{ steps.gitversion.outputs.branchName }}"
        echo "Sha: ${{ steps.gitversion.outputs.sha }}"
    
    - name: Restore dependencies
      run: dotnet restore AcceptanceTesting.Core.sln
    
    - name: Build solution using MSBuild
      run: dotnet msbuild AcceptanceTesting.Core.sln -p:Configuration=${{ env.CONFIGURATION }} -p:RestorePackages=false

    - name: Install Playwright browsers
      run: pwsh src/Playwright.Tests/bin/${{ env.CONFIGURATION }}/net8.0/playwright.ps1 install --with-deps
    
    - name: Configure test environment
      run: |
        echo "ASPNETCORE_ENVIRONMENT=Production" >> $GITHUB_ENV
        echo "Playwright__EnableHeadlessBrowser=true" >> $GITHUB_ENV

    - name: Check build outputs
      run: |
        echo "Checking build outputs for packable projects:"
        find . -name "*.csproj" -type f | while read proj; do
          if grep -q "<IsPackable>true</IsPackable>" "$proj" 2>/dev/null; then
            project_name=$(basename "$proj" .csproj)
            project_dir=$(dirname "$proj")
            output_dir="$project_dir/bin/${{ env.CONFIGURATION }}/net8.0/"
            if [ -d "$output_dir" ]; then
              echo "✅ $project_name: Build output found at $output_dir"
              ls -la "$output_dir" | head -3
            else
              echo "❌ $project_name: Build output not found at $output_dir"
            fi
            echo "---"
          fi
        done

    - name: Run tests
      run: dotnet test AcceptanceTesting.Core.sln --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal

    - name: Create output directory
      run: mkdir -p ./nupkgs

    - name: Discover and pack all IsPackable projects
      run: |
        echo "Auto-discovering projects with IsPackable=true..."
        echo "Using version: ${{ steps.gitversion.outputs.nuGetVersion }}"
        
        # Find all .csproj files that have IsPackable=true
        # Search in both root and src directories
        packable_projects=$(find . -name "*.csproj" -type f -exec grep -l "<IsPackable>true</IsPackable>" {} \; 2>/dev/null | sort)
        
        if [ -z "$packable_projects" ]; then
          echo "No projects found with IsPackable=true"
          echo "Searching for all .csproj files to debug..."
          find . -name "*.csproj" -type f | head -10
          echo ""
          echo "Checking IsPackable patterns in found projects..."
          find . -name "*.csproj" -type f -exec grep -H -i "ispackable" {} \; | head -10
          exit 1
        fi
        
        echo "Found packable projects:"
        echo "$packable_projects"
        echo ""
        
        # Create an array to track success/failure
        declare -A pack_results
        total_projects=0
        successful_packs=0
        
        # Pack each project
        while IFS= read -r project; do
          if [ ! -z "$project" ]; then
            project_name=$(basename "$project" .csproj)
            project_dir=$(dirname "$project")
            total_projects=$((total_projects + 1))
            
            echo "=========================================="
            echo "Packing: $project_name"
            echo "Project file: $project"
            echo "Directory: $project_dir"
            echo "=========================================="
            
            if dotnet pack "$project" \
              --configuration ${{ env.CONFIGURATION }} \
              --output ./nupkgs \
              --include-symbols \
              -p:SymbolPackageFormat=snupkg \
              -p:Version="${{ steps.gitversion.outputs.nuGetVersion }}" \
              -p:AssemblyVersion="${{ steps.gitversion.outputs.assemblySemVer }}" \
              -p:FileVersion="${{ steps.gitversion.outputs.assemblySemFileVer }}" \
              -p:InformationalVersion="${{ steps.gitversion.outputs.informationalVersion }}" \
              --verbosity normal; then
              
              echo "✅ Successfully packed: $project_name"
              pack_results["$project_name"]="SUCCESS"
              successful_packs=$((successful_packs + 1))
            else
              echo "❌ Failed to pack: $project_name"
              pack_results["$project_name"]="FAILED"
            fi
            echo ""
          fi
        done <<< "$packable_projects"
        
        echo "=========================================="
        echo "PACKING SUMMARY"
        echo "=========================================="
        echo "Total projects found: $total_projects"
        echo "Successfully packed: $successful_packs"
        echo "Failed: $((total_projects - successful_packs))"
        echo ""
        
        for project in "${!pack_results[@]}"; do
          status="${pack_results[$project]}"
          if [ "$status" = "SUCCESS" ]; then
            echo "✅ $project"
          else
            echo "❌ $project"
          fi
        done
        
        echo ""
        echo "Packages created:"
        ls -la ./nupkgs/ 2>/dev/null || echo "No packages found"
        
        # Exit with error if no projects were successfully packed
        if [ "$successful_packs" -eq 0 ]; then
          echo "ERROR: No projects were successfully packed!"
          exit 1
        fi
    
    - name: Upload NuGet packages as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: |
          ./nupkgs/*.nupkg
          ./nupkgs/*.snupkg
        if-no-files-found: error
        retention-days: 30

  publish:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    
    steps:
    - name: Download NuGet packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: ./nupkgs
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Push NuGet packages to GitHub Packages
      run: dotnet nuget push "./nupkgs/*.nupkg" --source "https://nuget.pkg.github.com/AlmostCoherent/index.json" --api-key "${{ secrets.GH_NUGET_TOKEN }}" --skip-duplicate